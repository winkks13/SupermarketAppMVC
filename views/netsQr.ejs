<%- include('partials/head', { pageTitle: title || 'NETS QR Payment' }) %>
<script src="https://unpkg.com/event-source-polyfill"></script>

<section class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4 p-lg-5">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
                    <div>
                        <p class="text-uppercase small text-muted mb-1">NETS QR payment</p>
                        <h1 class="h3 mb-2">Scan the QR to complete checkout</h1>
                        <p id="status" class="text-muted mb-0">Scan with your bank simulator app to complete payment.</p>
                    </div>
                    <span id="timer" class="badge bg-light text-dark px-3 py-2">Time remaining: 5:00</span>
                </div>
                <div class="row g-4 align-items-center">
                    <div class="col-lg-5">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body p-4 text-center">
                                <p class="small text-muted text-uppercase mb-3">Scan this code</p>
                                <img class="img-fluid rounded-3 shadow-sm border" src="<%= qrCodeUrl %>" alt="NETS QR Code">
                                <div class="mt-3 small text-muted">Keep this window open while completing payment.</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-7">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body p-4">
                                <p class="text-uppercase small text-muted mb-3">How it works</p>
                                <img class="img-fluid rounded-3 shadow-sm border" src="/images/netsQrInfo.png" alt="NETS QR steps">
                                <div class="d-flex flex-wrap gap-3 mt-4">
                                    <a href="/checkout" class="btn btn-outline-secondary">Back to checkout</a>
                                    <span class="badge bg-primary-subtle text-primary align-self-center">Secure NETS gateway</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
        let s2sNetsTxnStatus; // Declare a variable to hold the EventSource instance

        if (s2sNetsTxnStatus) {
            s2sNetsTxnStatus.close();
        }

        const txnRetrievalRef = "<%= txnRetrievalRef %>"; // Transaction reference
        const url = `/sse/payment-status/${txnRetrievalRef}`; 

        const headers = {
            "api-key": "<%= apiKey %>",
            "project-id": "<%= projectId %>",
        };

        console.log("NETS REQUEST response:", <%- JSON.stringify(fullNetsResponse) %>);

        const statusApiUrl = `/api/nets/payment-status/${encodeURIComponent(txnRetrievalRef)}`;
        let fallbackInterval = null;
        let hasRedirected = false;
        const timerElement = document.getElementById("timer");
        const countdownDuration = 300;
        let remainingTime = countdownDuration;
        let timerInterval = null;

        const updateTimerDisplay = () => {
            if (!timerElement) {
                return;
            }
            const minutes = Math.floor(Math.max(remainingTime, 0) / 60);
            const seconds = Math.max(remainingTime, 0) % 60;
            timerElement.textContent = `Time remaining: ${minutes}:${seconds.toString().padStart(2, "0")}`;
        };

        const startTimer = () => {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();
                if (remainingTime < 0) {
                    timerElement.textContent = "Transaction timed out.";
                    finalizeRedirect(`/nets-qr/fail?txn_retrieval_ref=${txnRetrievalRef}`);
                }
            }, 1000);
        };

        const stopTimer = () => {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        };

        const stopFallbackPolling = () => {
            if (fallbackInterval) {
                clearInterval(fallbackInterval);
                fallbackInterval = null;
            }
        };

        const finalizeRedirect = (redirectUrl) => {
            if (hasRedirected) {
                return;
            }
            hasRedirected = true;
            stopFallbackPolling();
            if (s2sNetsTxnStatus) {
                s2sNetsTxnStatus.close();
            }
            stopTimer();
            window.location.href = redirectUrl;
        };

        const handleStatusPayload = ({ raw = {}, success, fail, status }) => {
            if (hasRedirected) {
                return;
            }
            const statusDesc = String(raw.txn_status_desc || "").toLowerCase();
            const paymentDesc = String(raw.payment_status_desc || "").toLowerCase();
            const responseCode = String(raw.response_code || "");
            const txnStatus = Number(raw.txn_status);

            if (success || status === "success") {
                finalizeRedirect(`/nets-qr/success?txn_retrieval_ref=${txnRetrievalRef}`);
                return;
            }

            if (fail || status === "fail") {
                finalizeRedirect(`/nets-qr/fail?txn_retrieval_ref=${txnRetrievalRef}`);
                return;
            }

            if (
                responseCode === "00" &&
                (txnStatus === 2 ||
                    statusDesc.includes("success") ||
                    statusDesc.includes("approved") ||
                    statusDesc.includes("completed") ||
                    paymentDesc.includes("success") ||
                    paymentDesc.includes("approved") ||
                    paymentDesc.includes("completed"))
            ) {
                finalizeRedirect(`/nets-qr/success?txn_retrieval_ref=${txnRetrievalRef}`);
            }
        };

        const pollFallbackStatus = async () => {
            if (hasRedirected) {
                return;
            }
            try {
                const response = await fetch(statusApiUrl, {
                    credentials: "include"
                });
                if (!response.ok) {
                    throw new Error(`NETS fallback poll failed with status ${response.status}`);
                }
                const payload = await response.json();
                console.log("NETS fallback status response:", payload);
                handleStatusPayload({ raw: payload.raw || {}, status: payload.status });
            } catch (error) {
                console.error("NETS fallback poll error:", error);
            }
        };

        const startFallbackPolling = () => {
            stopFallbackPolling();
            fallbackInterval = setInterval(pollFallbackStatus, 3000);
            pollFallbackStatus();
        };

        // Initialize EventSource with credentials for session cookies.
        const EventSourceClient = window.EventSourcePolyfill || window.EventSource
        if (!EventSourceClient) {
            console.error('EventSource is not supported in this browser.')
        } else {
            const options = {
                withCredentials: true,
                heartbeatTimeout: 150000,
            }
            if (EventSourceClient === window.EventSourcePolyfill) {
                options.headers = headers
            }
            s2sNetsTxnStatus = new EventSourceClient(url, options)
        }

        s2sNetsTxnStatus?.addEventListener("message", (event) => {
            let data = null
            try {
                data = JSON.parse(event.data)
            } catch (error) {
                console.error('Unable to parse NETS status payload.', error)
                return
            }
            console.log("NETS Query Response:", data);
            const raw = data.raw || {};
            handleStatusPayload({
                raw,
                success: data.success,
                fail: data.fail
            });
        });

        startFallbackPolling();
        startTimer();
        console.log("Initialized EventSourcePolyfill");
    </script>
<%- include('partials/footer') %>
