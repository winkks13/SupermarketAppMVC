<%- include('partials/head', { pageTitle: product.productName }) %>

<div class="row g-5 align-items-center">
    <div class="col-md-5">
        <img src="/images/<%= product.image %>" class="img-fluid rounded-4 shadow" alt="<%= product.productName %>">
    </div>
    <div class="col-md-7">
        <div class="d-flex align-items-center justify-content-between mb-2">
            <span class="badge bg-light text-dark"><%= product.category || 'General' %></span>
            <form action="/products/<%= product.id %>/wishlist/<%= isWishlisted ? 'remove' : 'add' %>" method="POST" class="m-0">
                <button class="btn btn-outline-secondary btn-sm" type="submit"><%= isWishlisted ? '♥ Saved' : '♡ Save' %></button>
            </form>
        </div>
        <h1 class="display-6 fw-bold mb-2"><%= product.productName %></h1>
        <div class="d-flex align-items-center gap-3 mb-3">
            <p class="lead text-primary fw-semibold mb-0">$<%= Number(product.price).toFixed(2) %></p>
            <% const avg = Number((rating?.avgRating ?? 5)).toFixed(1) %>
            <% const fullStars = Math.round(rating?.avgRating ?? 5) %>
            <div class="d-flex align-items-center gap-2">
                <div class="text-warning small">
                    <% for(let s = 1; s <= 5; s++) { %>
                        <span><%= s <= fullStars ? '★' : '☆' %></span>
                    <% } %>
                </div>
                <span class="small text-muted"><%= avg %> (<%= rating?.reviewCount || 0 %>)</span>
            </div>
        </div>
        <p class="mb-4"><%= description %></p>
        <p class="text-muted">
            <% if (product.quantity === 0) { %>
                Currently out of stock. Check back soon!
            <% } else if (product.quantity <= 3) { %>
                Hurry! Only <%= product.quantity %> unit(s) left.
            <% } else { %>
                <%= product.quantity %> unit(s) ready for checkout.
            <% } %>
        </p>
        <form action="/cart/items/<%= product.id %>" method="POST" class="d-flex gap-3 align-items-center">
            <div class="flex-grow-0">
                <label class="form-label small text-muted">Quantity</label>
                <div class="input-group quantity-control" data-stock="<%= product.quantity %>">
                    <button class="btn btn-outline-secondary qty-btn" type="button" data-change="-1" <%= product.quantity === 0 ? 'disabled' : '' %>>-</button>
                    <input
                        type="number"
                        class="form-control text-center qty-input"
                        name="quantity"
                        value="<%= product.quantity ? 1 : 0 %>"
                        min="1"
                        max="<%= Math.max(product.quantity, 1) %>"
                        inputmode="numeric"
                        <%= product.quantity === 0 ? 'disabled' : '' %>
                    >
                    <button class="btn btn-outline-secondary qty-btn" type="button" data-change="1" <%= product.quantity === 0 ? 'disabled' : '' %>>+</button>
                </div>
            </div>
            <button class="btn btn-primary btn-lg flex-grow-1" type="submit" <%= product.quantity === 0 ? 'disabled' : '' %>>
                Add to cart
            </button>
        </form>
        <a href="/shop" class="btn btn-link mt-3">Back to shop</a>
    </div>
</div>

<div class="row mt-5">
    <div class="col-md-7">
        <h3 class="h5 mb-3">Customer reviews</h3>
        <% if (!reviews.length) { %>
            <p class="text-muted">No reviews yet. Be the first to review this product.</p>
        <% } %>
        <div class="list-group">
            <% reviews.forEach(review => { %>
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="text-warning small">
                            <% for(let s = 1; s <= 5; s++) { %>
                                <span><%= s <= review.rating ? '★' : '☆' %></span>
                            <% } %>
                        </div>
                        <span class="text-muted small"><%= new Date(review.createdAt).toLocaleString() %></span>
                    </div>
                    <p class="mb-1 fw-semibold"><%= review.username || 'Customer' %></p>
                    <p class="mb-0"><%= review.comment || 'No comment provided.' %></p>
                </div>
            <% }) %>
        </div>
    </div>
    <div class="col-md-5">
        <h3 class="h5 mb-3">Leave a review</h3>
        <form action="/products/<%= product.id %>/reviews" method="POST" class="v-stack gap-3">
            <div>
                <label class="form-label">Rating</label>
                <div class="d-flex align-items-center gap-2">
                    <select class="form-select w-auto" name="rating">
                        <% for(let r = 1; r <= 5; r++) { %>
                            <option value="<%= r %>" <%= r === 5 ? 'selected' : '' %>><%= r %> star<%= r > 1 ? 's' : '' %></option>
                        <% } %>
                    </select>
                    <div class="text-warning small">
                        ★★★★★
                    </div>
                </div>
            </div>
            <div>
                <label class="form-label" for="comment">Comment</label>
                <textarea class="form-control" id="comment" name="comment" rows="3" placeholder="Share your thoughts about this product"></textarea>
            </div>
            <button class="btn btn-primary" type="submit">Submit review</button>
        </form>
    </div>
</div>

<script>
    document.querySelectorAll('.quantity-control').forEach(control => {
        const stock = Number(control.dataset.stock) || 0
        const input = control.querySelector('.qty-input')
        const buttons = control.querySelectorAll('.qty-btn')

        if (stock < 1) {
            input.value = 0
            buttons.forEach(btn => btn.disabled = true)
            return
        }

        const clamp = () => {
            let value = Number(input.value) || 1
            value = Math.min(stock, Math.max(1, value))
            input.value = value
            buttons.forEach(btn => {
                const delta = Number(btn.dataset.change)
                btn.disabled = (delta < 0 && value <= 1) || (delta > 0 && value >= stock)
            })
        }

        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const delta = Number(btn.dataset.change) || 0
                input.value = Number(input.value || 1) + delta
                clamp()
            })
        })

        input.addEventListener('input', clamp)
        clamp()
    })
</script>

<%- include('partials/footer') %>
