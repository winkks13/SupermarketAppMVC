<%- include('partials/head', { pageTitle: 'PayPal payment' }) %>

<div class="row g-4">
    <div class="col-lg-7">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <p class="text-uppercase small text-muted mb-1">Payment</p>
                <div class="d-grid gap-2">
                    <div id="paypal-buttons-paypal"></div>
                    <div id="paypal-buttons-card"></div>
                </div>
                <form class="mt-3" action="/checkout" method="POST">
                    <input type="hidden" name="paymentMethod" value="card">
                    <button class="btn btn-dark w-100" type="submit">Pay with credit or debit card</button>
                </form>
                <p class="text-muted small mt-2 mb-0 text-center">Powered by PayPal</p>
                <p class="text-danger small mt-2 mb-0" id="paypal-error" style="display: none;"></p>
                <p class="text-muted small mt-3 mb-0 text-center">Shipping to: <%= shippingAddress %></p>
                <div class="mt-4">
                    <a class="btn btn-outline-secondary w-100" href="/checkout">Back to checkout</a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-5">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <h3 class="h5 mb-4">Order summary</h3>
                <ul class="list-group list-group-flush mb-3">
                    <% cart.items.forEach(item => { %>
                        <li class="list-group-item d-flex justify-content-between">
                            <div>
                                <strong><%= item.productName %></strong>
                                <p class="text-muted small mb-0"><%= item.quantity %> x $<%= Number(item.price).toFixed(2) %></p>
                            </div>
                            <span class="fw-bold">$<%= (item.price * item.quantity).toFixed(2) %></span>
                        </li>
                    <% }) %>
                </ul>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Subtotal</span>
                    <strong>$<%= cart.totals.subtotal.toFixed(2) %></strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Tax</span>
                    <strong>$<%= cart.totals.tax.toFixed(2) %></strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span>Total</span>
                    <strong class="fs-4">$<%= cart.totals.total.toFixed(2) %></strong>
                </div>
            </div>
        </div>
    </div>
</div>

<% if (paypalClientId) { %>
    <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=SGD&enable-funding=card"></script>
    <script>
        const paypalError = document.getElementById('paypal-error')

        const paypalConfig = {
            createOrder: async () => {
                paypalError.style.display = 'none'
                const response = await fetch('/api/paypal/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                })

                const data = await response.json()
                if (!response.ok) {
                    throw new Error(data.error || 'Unable to create PayPal order')
                }

                return data.id
            },
            onApprove: async (data) => {
                paypalError.style.display = 'none'
                const response = await fetch('/api/paypal/capture-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: data.orderID })
                })
                const result = await response.json()
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Unable to capture PayPal order')
                }
                window.location.href = '/orders/history'
            },
            onError: (err) => {
                console.error(err)
                paypalError.textContent = 'PayPal payment failed. Please try again.'
                paypalError.style.display = 'block'
            }
        }

        if (!window.paypal) {
            paypalError.textContent = 'PayPal failed to load. Please refresh or disable blockers.'
            paypalError.style.display = 'block'
        } else {
            paypal.Buttons({
                ...paypalConfig,
                fundingSource: paypal.FUNDING.PAYPAL,
                style: {
                    layout: 'vertical',
                    color: 'gold',
                    shape: 'rect',
                    label: 'paypal'
                }
            }).render('#paypal-buttons-paypal')

            paypal.Buttons({
                ...paypalConfig,
                fundingSource: paypal.FUNDING.CARD,
                style: {
                    layout: 'vertical',
                    color: 'black',
                    shape: 'rect',
                    label: 'card'
                }
            }).render('#paypal-buttons-card')

            setTimeout(() => {
                if (!document.querySelector('#paypal-buttons-card iframe')) {
                    const hint = document.createElement('p')
                    hint.className = 'text-muted small mt-2 mb-0 text-center'
                    hint.textContent = 'Card button unavailable for this PayPal account or region.'
                    document.getElementById('paypal-buttons-card').appendChild(hint)
                }
            }, 800)
        }
    </script>
<% } else { %>
    <script>
        const paypalError = document.getElementById('paypal-error')
        paypalError.textContent = 'PayPal is not configured. Add PAYPAL_CLIENT_ID and restart.'
        paypalError.style.display = 'block'
    </script>
<% } %>

<%- include('partials/footer') %>
